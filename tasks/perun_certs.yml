- name: "install ssl-cert"
  apt:
    name: ssl-cert

- name: "create perun group"
  group:
    name: "perun"
    system: yes
    gid: 960

- name: "create perun user"
  user:
    name: "perun"
    uid: 960
    group: "perun"
    comment: "Perun himself"
    shell: /bin/bash
    system: yes
    create_home: no

# ssl-cert group is created by the ssl-cert package, it is used by packages like postgres and openldap which need access to private keys
# perun user needs access to host key for authentication when uploading to URLs
- name: "add user perun to group ssl-cert"
  user:
    name: perun
    groups: ssl-cert
    append: yes

- name: "create {{ perun_certs_dir }} directory"
  file:
    path: "{{ perun_certs_dir }}"
    state: directory

- name: "set host key"
  copy:
    src: "{{ inventory_hostname }}/hostkey.pem"
    dest: "{{ perun_certs_dir }}/hostkey.pem"
    owner: root
    group: ssl-cert
    mode: 0640

- name: "set host certificate"
  copy:
    src: "{{ inventory_hostname }}/hostcert.pem"
    dest: "{{ perun_certs_dir }}/hostcert.pem"
    owner: root
    group: root
    mode: 0644

- name: "set host chain"
  copy:
    src: "{{ inventory_hostname }}/hostchain.pem"
    dest: "{{ perun_certs_dir }}/hostchain.pem"
    owner: root
    group: root
    mode: 0644
