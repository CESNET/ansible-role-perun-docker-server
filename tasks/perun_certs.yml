- name: "install ssl-cert"
  apt:
    name: ssl-cert

- name: "create {{ perun_certs_dir }} directory"
  file:
    path: "{{ perun_certs_dir }}"
    state: directory

- name: "set host key"
  copy:
    src: "{{ inventory_hostname }}/hostkey.pem"
    dest: "{{ perun_certificate_key_file }}"
    owner: root
    group: ssl-cert
    mode: 0640

- name: "set host certificate"
  copy:
    src: "{{ inventory_hostname }}/hostcert.pem"
    dest: "{{ perun_certificate_file}}"
    owner: root
    group: root
    mode: 0644
  register: certfile

- name: "set host chain"
  copy:
    src: "{{ inventory_hostname }}/hostchain.pem"
    dest: "{{ perun_certificate_chain_file }}"
    owner: root
    group: root
    mode: 0644

- name: "assemble full chain"
  shell:
    chdir: "{{ perun_certs_dir }}"
    cmd: "cat {{ perun_certificate_file}} {{ perun_certificate_chain_file }} >{{ perun_certificate_fullchain_file }}"
  when: certfile.changed

- name: "set NGUI key"
  copy:
    src: "{{ inventory_hostname }}/nguikey.pem"
    dest: "{{ perun_certs_dir }}/nguikey.pem"
    owner: root
    group: ssl-cert
    mode: 0640

- name: "set NGUI certificate"
  copy:
    src: "{{ inventory_hostname }}/nguicert.pem"
    dest: "{{ perun_certs_dir }}/nguicert.pem"
    owner: root
    group: root
    mode: 0644

- name: "set NGUI chain"
  copy:
    src: "{{ inventory_hostname }}/nguichain.pem"
    dest: "{{ perun_certs_dir }}/nguichain.pem"
    owner: root
    group: root
    mode: 0644
