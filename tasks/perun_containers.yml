# install Portainer web app for managing containers
- name: "create volume for portainer"
  docker_volume:
    name: portainer_data

- name: "create password file"
  copy:
    dest: "{{ perun_certs_dir }}/portainer_admin_password.txt"
    content: "{{ perun_portainer_admin_password }}"

- name: "install portainer container"
  docker_container:
    name: portainer
    image: portainer/portainer
    restart_policy: always
    command: "-H unix:///var/run/docker.sock --ssl --sslcert {{ perun_certificate_fullchain_file }} --sslkey {{ perun_certificate_key_file }} --admin-password-file {{ perun_certs_dir }}/portainer_admin_password.txt"
    ports:
      - 9000:9000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
      - "{{ perun_certs_dir }}:{{ perun_certs_dir }}:ro"

- name: "create /var/log/perun"
  file:
    state: directory
    path: /var/log/perun

- name: "create docker volumes for data"
  include_tasks:
    file: volume_dir.yml
    apply:
      tags:
        - perun_containers
  loop:
    - { name: 'perunrpc_logs', link: "/var/log/perun/perunrpc", owner: perunrpc }
    - { name: 'peruneng_logs', link: "/var/log/perun/peruneng", owner: peruneng }
    - { name: 'perunldc_logs', link: "/var/log/perun/perunldc", owner: perunldc }
    - { name: 'perunrpc_home', link: "/home/perunrpc", owner: perunrpc }
    - { name: 'peruneng_home', link: "/home/peruneng", owner: peruneng }
    - { name: 'perunldc_home', link: "/home/perunldc", owner: perunldc }
    - { name: 'perunrpc_etc',  link: "/etc/perun/perunrpc", owner: perunrpc }
    - { name: 'peruneng_etc',  link: "/etc/perun/peruneng", owner: peruneng }
    - { name: 'perunldc_etc',  link: "/etc/perun/perunldc", owner: perunldc }
  loop_control:
    loop_var: volume
    label: "{{ volume.name }}"

- name: "create volume for apache logs"
  docker_volume:
    name: apache_logs
  register: volume_apache_logs
- name: "create link /var/log/apache2 to volume apache_logs"
  file:
    state: link
    src: "{{ volume_apache_logs.volume.Mountpoint }}"
    path: /var/log/apache2
    force: yes

- name: "create jdbc.properties (contains db password)"
  template:
    src: jdbc.properties.j2
    dest: "{{ item }}"
    owner: perunrpc
    group: perunrpc
    mode: 0440
  loop:
    - /etc/perun/perunrpc/jdbc.properties
    - /etc/perun/perunldc/jdbc.properties

- name: "create perun-web-gui.properties (contains several variables)"
  template:
    src: perun-web-gui.properties.j2
    dest: /etc/perun/perunrpc/perun-web-gui.properties
    owner: perunrpc
    group: perunrpc
    mode: 0440

- name: "create perun.properties (contains several variables)"
  template:
    src: perun.properties.j2
    dest: /etc/perun/perunrpc/perun.properties
    owner: perunrpc
    group: perunrpc
    mode: 0440

- name: "login into gitlab docker registry"
  docker_login:
    registry_url: "registry.gitlab.ics.muni.cz:443"
    username: "gitlab-read-only-deploy-token-perun-docker"
    password: "K3tG1Np-yLVWB51jj3bB"

- name: "create a local Docker network for Perun"
  docker_network:
    name: perun_net
    driver_options:
      com.docker.network.driver.mtu: 1442
    ipam_config:
      - subnet: 192.168.0.0/24
        gateway: 192.168.0.1

- name: "create Perun engine container"
  docker_container:
    name: perun_engine
    image: "registry.gitlab.ics.muni.cz:443/perun/perun_docker/perun_engine:{{ perun_engine_container_version }}"
    pull: yes
#    restart_policy: always
    mounts:
      - { type: volume, source: peruneng_logs, target: /var/log/perun }
      - { type: volume, source: peruneng_home, target: /home/perun }
      - { type: volume, source: peruneng_etc,  target: /etc/perun }
    networks_cli_compatible: yes
    networks:
      - name: perun_net

- name: "create Perun RPC container"
  docker_container:
    name: perun_rpc
    image: "registry.gitlab.ics.muni.cz:443/perun/perun_docker/perun_rpc:{{ perun_rpc_container_version }}"
    pull: yes
    #    restart_policy: always
    mounts:
      - { type: volume, source: perunrpc_logs, target: /var/log/perun }
      - { type: volume, source: perunrpc_home, target: /home/perun }
      - { type: volume, source: perunrpc_etc, target: /etc/perun }
    networks_cli_compatible: yes
    networks:
      - name: perun_net

- name: "create Perun Apache container"
  docker_container:
    name: perun_apache
    image: "registry.gitlab.ics.muni.cz:443/perun/perun_docker/perun_apache:{{ perun_apache_container_version }}"
    pull: yes
    #    restart_policy: always
    mounts:
      - { type: volume, source: apache_logs, target: /var/log/apache2 }
      - { type: bind, source: /etc/perun/ssl, target: /etc/perun/ssl, read_only: yes }
      - { type: bind, source: /etc/perun/apache, target: /etc/perun/apache, read_only: yes }
    networks_cli_compatible: yes
    networks:
      - name: perun_net
    ports:
      - 80:80
      - 443:443
